/*!
*****************************************************************************
** \file        software/linux/kernel/drv/sensors/gc1024/gc1024.c
**
** \version     $Id: gc1024_ex.c 10876 2017-02-14 02:42:49Z hehuali $
**
** \brief
**
** \attention   THIS SAMPLE CODE IS PROVIDED AS IS. GOKE MICROELECTRONICS
**              ACCEPTS NO RESPONSIBILITY OR LIABILITY FOR ANY ERRORS OR
**              OMMISSIONS
**
** (C) Copyright 2012-2015 by GOKE MICROELECTRONICS CO.,LTD
**
*****************************************************************************
*/
#include <linux/module.h>
#include <linux/delay.h>
#include <linux/slab.h>
#include "gk_sensor.h"
#include "gc1024_pri.h"

//#define SET_REG_BY_VSYNC
#ifdef SET_REG_BY_VSYNC
#define SET_SHUTTER_BY_VSYNC
#endif

typedef struct
{
    //GK_Vi_SensorT api;
    int sub_id;
#ifdef SET_REG_BY_VSYNC
    int gc1024_adc_ch;
    int gc1024_reg_fe;  //page0
    int gc1024_reg_b6;  //agc: 0=>1x
    int gc1024_reg_b1;  //dgc: 1.0x
    int gc1024_reg_b2;  //dgc: 1.0x

    int gc1024_last_reg_fe;
    int gc1024_last_reg_b6;
    int gc1024_last_reg_b1;
    int gc1024_last_reg_b2;

#ifdef SET_SHUTTER_BY_VSYNC
    int gc1024_shutter_ch;
    int gc1024_reg_exp_time_h;
    int gc1024_reg_exp_time_l;

    int gc1024_last_reg_exp_time_h;
    int gc1024_last_reg_exp_time_l;
#endif
#endif

    u8 gc1024_mirror_need_up;
    int gc1024_crop_ver_l;
    int gc1024_crop_hor_l;
    int gc1024_mirror_flip;

//0728 hhl add for fps_change bug.
    int fps_set_flag;
    int fps_frame_len_bak; //default: 20fps   //900: 25fps
}GK_Vi_Sensor_GC1024T;
//*****************************************************************************
//*****************************************************************************
//** Local structures
//*****************************************************************************
//*****************************************************************************
#define GC1024_GAIN_ROWS            356
typedef struct gc1024_gain_table
{
    u8 GC1024_REG_FE;
    u8 GC1024_REG_B6;
    u8 GC1024_REG_B1;
    u8 GC1024_REG_B2;
    u32 db_value;
}gc1024_gain_table_s;

//*****************************************************************************
//*****************************************************************************
//** Global Data
//*****************************************************************************
//*****************************************************************************

//*****************************************************************************
//*****************************************************************************
//** Local Data
//*****************************************************************************
//*****************************************************************************
static int gc1024_get_vblank_time(int handle, GK_Vi_SensorT* sensor_extern, u32* ptime, u32 extclk, u32 pclk);
static int gc1024_set_agc_db(int handle, GK_Vi_SensorT* sensor_extern, s32 agc_db);
static int gc1024_set_shutter_time(int handle, GK_Vi_SensorT* sensor_extern, u32 shutter_time, u32 extclk, u32 pclk);
static int gc1024_set_fps(int handle, GK_Vi_SensorT* sensor_extern, u32 fps, u32 extclk, u32 pclk);
static int gc1024_set_mirror_mode(int handle, GK_Vi_SensorT* sensor_extern, u32 mirr_mode);
static int gc1024_set_update_reg(int handle, GK_Vi_SensorT* sensor_extern);
static GK_Vi_SensorT gc1024_dev;

#if 0
static GK_Vi_Sensor_GC1024T gc1024 =
{
    .api =
    {
        .sensor_id                = GK_VI_SENSOR_GC1024,
        .length                   = sizeof(GK_Vi_Sensor_GC1024T),
        .sensor_get_vblank_time   = gc1024_get_vblank_time,
        .sensor_set_shutter_time  = gc1024_set_shutter_time,
        .sensor_set_fps           = gc1024_set_fps,
        .sensor_set_agc_db        = gc1024_set_agc_db,
        .sensor_set_mirror_mode   = gc1024_set_mirror_mode,
        .sensor_set_update_reg    = gc1024_set_update_reg,
    },
#ifdef SET_REG_BY_VSYNC
    .gc1024_adc_ch = 0,
    .gc1024_reg_fe = 0x00,  //page0
    .gc1024_reg_b6 = 0x00,  //agc: 0=>1x
    .gc1024_reg_b1 = 0x01,  //dgc: 1.0x
    .gc1024_reg_b2 = 0x00,  //dgc: 1.0x

    .gc1024_last_reg_fe = 0xffffffff,
    .gc1024_last_reg_b6 = 0xffffffff,
    .gc1024_last_reg_b1 = 0xffffffff,
    .gc1024_last_reg_b2 = 0xffffffff,

#ifdef SET_SHUTTER_BY_VSYNC
    .gc1024_shutter_ch = 0,
    .gc1024_reg_exp_time_h = 0,
    .gc1024_reg_exp_time_l = 0,

    .gc1024_last_reg_exp_time_h = 0xffffffff,
    .gc1024_last_reg_exp_time_l = 0xffffffff,
#endif
#endif

    .gc1024_mirror_need_up = 0,
    .gc1024_crop_ver_l = 0x01,
    .gc1024_crop_hor_l = 0x03,
    .gc1024_mirror_flip = 0x03,

        //0728 hhl add for fps_change bug.
    .fps_set_flag = 0,
    .fps_frame_len_bak = 921, //default: 20fps   //900: 25fps
};
#endif

const gc1024_gain_table_s GC1024_GLOBAL_GAIN_TABLE[GC1024_GAIN_ROWS] =
{
    //0xfe, 0xb6, 0xb1, 0xb2
    {0x00, 0x00, 0x01, 0x00, 0x00000000,},   //1.000000,   //0.000000   //
    {0x00, 0x00, 0x01, 0x04, 0x00225b61,},   //1.015625,   //0.134207   //
    {0x00, 0x00, 0x01, 0x08, 0x0044307a,},   //1.031250,   //0.266365   //
    {0x00, 0x00, 0x01, 0x0c, 0x00658353,},   //1.046875,   //0.396535   //
    {0x00, 0x00, 0x01, 0x10, 0x008657c9,},   //1.062500,   //0.524777   //
    {0x00, 0x00, 0x01, 0x14, 0x00a6b18d,},   //1.078125,   //0.651147   //
    {0x00, 0x00, 0x01, 0x18, 0x00c69426,},   //1.093750,   //0.775698   //
    {0x00, 0x00, 0x01, 0x1c, 0x00e602f6,},   //1.109375,   //0.898483   //
    {0x00, 0x00, 0x01, 0x20, 0x0105013a,},   //1.125000,   //1.019550   //
    {0x00, 0x00, 0x01, 0x24, 0x0123920d,},   //1.140625,   //1.138947   //
    {0x00, 0x00, 0x01, 0x28, 0x0141b86a,},   //1.156250,   //1.256720   //
    {0x00, 0x00, 0x01, 0x2c, 0x015f772b,},   //1.171875,   //1.372912   //
    {0x00, 0x00, 0x01, 0x30, 0x017cd110,},   //1.187500,   //1.487565   //
    {0x00, 0x00, 0x01, 0x34, 0x0199c8bc,},   //1.203125,   //1.600719   //
    {0x00, 0x00, 0x01, 0x38, 0x01b660b8,},   //1.218750,   //1.712413   //
    {0x00, 0x00, 0x01, 0x3c, 0x01d29b73,},   //1.234375,   //1.822684   //
    {0x00, 0x00, 0x01, 0x40, 0x01ee7b47,},   //1.250000,   //1.931569   //
    {0x00, 0x00, 0x01, 0x44, 0x020a0275,},   //1.265625,   //2.039100   //
    {0x00, 0x00, 0x01, 0x48, 0x0225332b,},   //1.281250,   //2.145312   //
    {0x00, 0x00, 0x01, 0x4c, 0x02400f81,},   //1.296875,   //2.250237   //
    {0x00, 0x00, 0x01, 0x50, 0x025a997c,},   //1.312500,   //2.353905   //
    {0x00, 0x00, 0x01, 0x54, 0x0274d310,},   //1.328125,   //2.456346   //
    {0x00, 0x00, 0x01, 0x58, 0x028ebe1f,},   //1.343750,   //2.557589   //
    {0x00, 0x00, 0x01, 0x5c, 0x02a85c78,},   //1.359375,   //2.657661   //
    {0x00, 0x00, 0x01, 0x60, 0x02c1afdd,},   //1.375000,   //2.756590   //
    {0x00, 0x00, 0x01, 0x64, 0x02dab9ff,},   //1.390625,   //2.854401   //
    {0x00, 0x00, 0x01, 0x68, 0x02f37c81,},   //1.406250,   //2.951119   //
    {0x00, 0x00, 0x01, 0x6c, 0x030bf8fa,},   //1.421875,   //3.046768   //
    {0x00, 0x00, 0x01, 0x70, 0x032430f0,},   //1.437500,   //3.141372   //
    {0x00, 0x00, 0x01, 0x74, 0x033c25de,},   //1.453125,   //3.234953   //
    {0x00, 0x00, 0x01, 0x78, 0x0353d935,},   //1.468750,   //3.327533   //
    {0x00, 0x00, 0x01, 0x7c, 0x036b4c57,},   //1.484375,   //3.419134   //
    {0x00, 0x00, 0x01, 0x80, 0x0382809d,},   //1.500000,   //3.509775   //
    {0x00, 0x00, 0x01, 0x84, 0x03997754,},   //1.515625,   //3.599477   //
    {0x00, 0x00, 0x01, 0x88, 0x03b031be,},   //1.531250,   //3.688259   //
    {0x00, 0x00, 0x01, 0x8c, 0x03c6b117,},   //1.546875,   //3.776140   //
    {0x00, 0x00, 0x01, 0x90, 0x03dcf68e,},   //1.562500,   //3.863137   //
    {0x00, 0x00, 0x01, 0x94, 0x03f30349,},   //1.578125,   //3.949269   //
    {0x00, 0x00, 0x01, 0x98, 0x0408d867,},   //1.593750,   //4.034552   //
    {0x00, 0x00, 0x01, 0x9c, 0x041e76fd,},   //1.609375,   //4.119003   //
    {0x00, 0x00, 0x01, 0xa0, 0x0433e01a,},   //1.625000,   //4.202638   //
    {0x00, 0x01, 0x01, 0x00, 0x04483c9d,},   //1.640000,   //4.282175   //
    {0x00, 0x01, 0x01, 0x04, 0x046a97fe,},   //1.665625,   //4.416382   //
    {0x00, 0x01, 0x01, 0x08, 0x048c6d17,},   //1.691250,   //4.548540   //
    {0x00, 0x01, 0x01, 0x0c, 0x04adbff0,},   //1.716875,   //4.678710   //
    {0x00, 0x01, 0x01, 0x10, 0x04ce9466,},   //1.742500,   //4.806952   //
    {0x00, 0x01, 0x01, 0x14, 0x04eeee2a,},   //1.768125,   //4.933322   //
    {0x00, 0x01, 0x01, 0x18, 0x050ed0c3,},   //1.793750,   //5.057873   //
    {0x00, 0x01, 0x01, 0x1c, 0x052e3f93,},   //1.819375,   //5.180658   //
    {0x00, 0x01, 0x01, 0x20, 0x054d3dd7,},   //1.845000,   //5.301725   //
    {0x00, 0x02, 0x01, 0x00, 0x055f2f50,},   //1.860000,   //5.371816   //
    {0x00, 0x02, 0x01, 0x04, 0x05818ab2,},   //1.889063,   //5.506023   //
    {0x00, 0x02, 0x01, 0x08, 0x05a35fcb,},   //1.918125,   //5.638180   //
    {0x00, 0x02, 0x01, 0x0c, 0x05c4b2a4,},   //1.947188,   //5.768351   //
    {0x00, 0x02, 0x01, 0x10, 0x05e5871a,},   //1.976250,   //5.896593   //
    {0x00, 0x02, 0x01, 0x14, 0x0605e0de,},   //2.005313,   //6.022962   //
    {0x00, 0x02, 0x01, 0x18, 0x0625c377,},   //2.034375,   //6.147514   //
    {0x00, 0x02, 0x01, 0x1c, 0x06453247,},   //2.063438,   //6.270298   //
    {0x00, 0x02, 0x01, 0x20, 0x0664308b,},   //2.092500,   //6.391366   //
    {0x00, 0x02, 0x01, 0x24, 0x0682c15e,},   //2.121563,   //6.510763   //
    {0x00, 0x02, 0x01, 0x28, 0x06a0e7ba,},   //2.150625,   //6.628536   //
    {0x00, 0x02, 0x01, 0x2c, 0x06bea67c,},   //2.179688,   //6.744728   //
    {0x00, 0x02, 0x01, 0x30, 0x06dc0061,},   //2.208750,   //6.859381   //
    {0x00, 0x02, 0x01, 0x34, 0x06f8f80d,},   //2.237813,   //6.972535   //
    {0x00, 0x02, 0x01, 0x38, 0x07159008,},   //2.266875,   //7.084229   //
    {0x00, 0x02, 0x01, 0x3c, 0x0731cac4,},   //2.295938,   //7.194500   //
    {0x00, 0x02, 0x01, 0x40, 0x074daa97,},   //2.325000,   //7.303384   //
    {0x00, 0x02, 0x01, 0x44, 0x076931c6,},   //2.354062,   //7.410916   //
    {0x00, 0x02, 0x01, 0x48, 0x0784627c,},   //2.383125,   //7.517128   //
    {0x00, 0x02, 0x01, 0x4c, 0x079f3ed2,},   //2.412187,   //7.622052   //
    {0x00, 0x02, 0x01, 0x50, 0x07b9c8cd,},   //2.441250,   //7.725720   //
    {0x00, 0x02, 0x01, 0x54, 0x07d40261,},   //2.470312,   //7.828161   //
    {0x00, 0x02, 0x01, 0x58, 0x07eded6f,},   //2.499375,   //7.929404   //
    {0x00, 0x02, 0x01, 0x5c, 0x08078bc9,},   //2.528438,   //8.029477   //
    {0x00, 0x02, 0x01, 0x60, 0x0820df2d,},   //2.557500,   //8.128405   //
    {0x00, 0x02, 0x01, 0x64, 0x0839e94f,},   //2.586563,   //8.226216   //
    {0x00, 0x02, 0x01, 0x68, 0x0852abd2,},   //2.615625,   //8.322934   //
    {0x00, 0x02, 0x01, 0x6c, 0x086b284a,},   //2.644688,   //8.418584   //
    {0x00, 0x02, 0x01, 0x70, 0x08836040,},   //2.673750,   //8.513187   //
    {0x00, 0x02, 0x01, 0x74, 0x089b552f,},   //2.702813,   //8.606769   //
    {0x00, 0x02, 0x01, 0x78, 0x08b30886,},   //2.731875,   //8.699349   //
    {0x00, 0x02, 0x01, 0x7c, 0x08ca7ba8,},   //2.760938,   //8.790949   //
    {0x00, 0x02, 0x01, 0x80, 0x08e1afee,},   //2.790000,   //8.881591   //
    {0x00, 0x02, 0x01, 0x84, 0x08f8a6a4,},   //2.819063,   //8.971293   //
    {0x00, 0x02, 0x01, 0x88, 0x090f610f,},   //2.848125,   //9.060075   //
    {0x00, 0x02, 0x01, 0x8c, 0x0925e068,},   //2.877188,   //9.147955   //
    {0x00, 0x02, 0x01, 0x90, 0x093c25de,},   //2.906250,   //9.234953   //
    {0x00, 0x02, 0x01, 0x94, 0x0952329a,},   //2.935313,   //9.321085   //
    {0x00, 0x02, 0x01, 0x98, 0x096807b8,},   //2.964375,   //9.406368   //
    {0x00, 0x02, 0x01, 0x9c, 0x097da64e,},   //2.993438,   //9.490819   //
    {0x00, 0x02, 0x01, 0xa0, 0x09930f6b,},   //3.022500,   //9.574454   //
    {0x00, 0x02, 0x01, 0xa4, 0x09a84414,},   //3.051563,   //9.657289   //
    {0x00, 0x02, 0x01, 0xa8, 0x09bd4548,},   //3.080625,   //9.739338   //
    {0x00, 0x02, 0x01, 0xac, 0x09d213ff,},   //3.109688,   //9.820618   //
    {0x00, 0x02, 0x01, 0xb0, 0x09e6b128,},   //3.138750,   //9.901141   //
    {0x00, 0x02, 0x01, 0xb4, 0x09fb1dae,},   //3.167813,   //9.980922   //
    {0x00, 0x02, 0x01, 0xb8, 0x0a0f5a74,},   //3.196875,   //10.059974  //
    {0x00, 0x03, 0x01, 0x00, 0x0a1f5341,},   //3.220000,   //10.122364  //
    {0x00, 0x03, 0x01, 0x04, 0x0a41aea3,},   //3.270313,   //10.256571  //
    {0x00, 0x03, 0x01, 0x08, 0x0a6383bb,},   //3.320625,   //10.388729  //
    {0x00, 0x03, 0x01, 0x0c, 0x0a84d695,},   //3.370938,   //10.518899  //
    {0x00, 0x03, 0x01, 0x10, 0x0aa5ab0b,},   //3.421250,   //10.647141  //
    {0x00, 0x03, 0x01, 0x14, 0x0ac604ce,},   //3.471563,   //10.773511  //
    {0x00, 0x03, 0x01, 0x18, 0x0ae5e768,},   //3.521875,   //10.898062  //
    {0x00, 0x03, 0x01, 0x1c, 0x0b055638,},   //3.572188,   //11.020847  //
    {0x00, 0x03, 0x01, 0x20, 0x0b24547c,},   //3.622500,   //11.141914  //
    {0x00, 0x04, 0x01, 0x00, 0x0b4132bb,},   //3.670000,   //11.254680  //
    {0x00, 0x04, 0x01, 0x04, 0x0b638e1d,},   //3.727344,   //11.388887  //
    {0x00, 0x04, 0x01, 0x08, 0x0b856336,},   //3.784688,   //11.521045  //
    {0x00, 0x04, 0x01, 0x0c, 0x0ba6b60f,},   //3.842031,   //11.651216  //
    {0x00, 0x04, 0x01, 0x10, 0x0bc78a85,},   //3.899375,   //11.779457  //
    {0x00, 0x04, 0x01, 0x14, 0x0be7e449,},   //3.956719,   //11.905827  //
    {0x00, 0x04, 0x01, 0x18, 0x0c07c6e2,},   //4.014062,   //12.030378  //
    {0x00, 0x04, 0x01, 0x1c, 0x0c2735b2,},   //4.071406,   //12.153163  //
    {0x00, 0x04, 0x01, 0x20, 0x0c4633f6,},   //4.128750,   //12.274230  //
    {0x00, 0x04, 0x01, 0x24, 0x0c64c4c9,},   //4.186094,   //12.393628  //
    {0x00, 0x04, 0x01, 0x28, 0x0c82eb25,},   //4.243437,   //12.511401  //
    {0x00, 0x04, 0x01, 0x2c, 0x0ca0a9e7,},   //4.300781,   //12.627593  //
    {0x00, 0x04, 0x01, 0x30, 0x0cbe03cc,},   //4.358125,   //12.742245  //
    {0x00, 0x04, 0x01, 0x34, 0x0cdafb78,},   //4.415469,   //12.855400  //
    {0x00, 0x04, 0x01, 0x38, 0x0cf79373,},   //4.472812,   //12.967094  //
    {0x00, 0x04, 0x01, 0x3c, 0x0d13ce2f,},   //4.530156,   //13.077365  //
    {0x00, 0x04, 0x01, 0x40, 0x0d2fae02,},   //4.587500,   //13.186249  //
    {0x00, 0x04, 0x01, 0x44, 0x0d4b3531,},   //4.644844,   //13.293780  //
    {0x00, 0x04, 0x01, 0x48, 0x0d6665e6,},   //4.702188,   //13.399992  //
    {0x00, 0x04, 0x01, 0x4c, 0x0d81423d,},   //4.759531,   //13.504917  //
    {0x00, 0x04, 0x01, 0x50, 0x0d9bcc38,},   //4.816875,   //13.608585  //
    {0x00, 0x04, 0x01, 0x54, 0x0db605cc,},   //4.874219,   //13.711026  //
    {0x00, 0x04, 0x01, 0x58, 0x0dcff0da,},   //4.931563,   //13.812269  //
    {0x00, 0x04, 0x01, 0x5c, 0x0de98f33,},   //4.988906,   //13.912341  //
    {0x00, 0x04, 0x01, 0x60, 0x0e02e298,},   //5.046250,   //14.011270  //
    {0x00, 0x04, 0x01, 0x64, 0x0e1becba,},   //5.103594,   //14.109081  //
    {0x00, 0x04, 0x01, 0x68, 0x0e34af3d,},   //5.160938,   //14.205799  //
    {0x00, 0x04, 0x01, 0x6c, 0x0e4d2bb5,},   //5.218281,   //14.301448  //
    {0x00, 0x04, 0x01, 0x70, 0x0e6563ab,},   //5.275625,   //14.396052  //
    {0x00, 0x04, 0x01, 0x74, 0x0e7d589a,},   //5.332969,   //14.489633  //
    {0x00, 0x04, 0x01, 0x78, 0x0e950bf1,},   //5.390313,   //14.582213  //
    {0x00, 0x04, 0x01, 0x7c, 0x0eac7f13,},   //5.447656,   //14.673814  //
    {0x00, 0x04, 0x01, 0x80, 0x0ec3b359,},   //5.505000,   //14.764455  //
    {0x00, 0x04, 0x01, 0x84, 0x0edaaa0f,},   //5.562344,   //14.854157  //
    {0x00, 0x04, 0x01, 0x88, 0x0ef1647a,},   //5.619687,   //14.942939  //
    {0x00, 0x04, 0x01, 0x8c, 0x0f07e3d3,},   //5.677031,   //15.030820  //
    {0x00, 0x04, 0x01, 0x90, 0x0f1e2949,},   //5.734375,   //15.117818  //
    {0x00, 0x04, 0x01, 0x94, 0x0f343605,},   //5.791719,   //15.203949  //
    {0x00, 0x04, 0x01, 0x98, 0x0f4a0b22,},   //5.849062,   //15.289232  //
    {0x00, 0x04, 0x01, 0x9c, 0x0f5fa9b9,},   //5.906406,   //15.373684  //
    {0x00, 0x04, 0x01, 0xa0, 0x0f7512d6,},   //5.963750,   //15.457319  //
    {0x00, 0x04, 0x01, 0xa4, 0x0f8a477f,},   //6.021094,   //15.540153  //
    {0x00, 0x04, 0x01, 0xa8, 0x0f9f48b3,},   //6.078437,   //15.622203  //
    {0x00, 0x04, 0x01, 0xac, 0x0fb4176a,},   //6.135781,   //15.703482  //
    {0x00, 0x04, 0x01, 0xb0, 0x0fc8b493,},   //6.193125,   //15.784005  //
    {0x00, 0x05, 0x01, 0x00, 0x0fd24d00,},   //6.220000,   //15.821487  //
    {0x00, 0x05, 0x01, 0x04, 0x0ff4a862,},   //6.317188,   //15.955694  //
    {0x00, 0x05, 0x01, 0x08, 0x10167d7b,},   //6.414375,   //16.087852  //
    {0x00, 0x05, 0x01, 0x0c, 0x1037d054,},   //6.511563,   //16.218023  //
    {0x00, 0x05, 0x01, 0x10, 0x1058a4ca,},   //6.608750,   //16.346265  //
    {0x00, 0x05, 0x01, 0x14, 0x1078fe8e,},   //6.705938,   //16.472634  //
    {0x00, 0x05, 0x01, 0x18, 0x1098e127,},   //6.803125,   //16.597186  //
    {0x00, 0x05, 0x01, 0x1c, 0x10b84ff7,},   //6.900313,   //16.719970  //
    {0x00, 0x05, 0x01, 0x20, 0x10d74e3b,},   //6.997500,   //16.841037  //
    {0x00, 0x05, 0x01, 0x24, 0x10f5df0e,},   //7.094688,   //16.960435  //
    {0x00, 0x05, 0x01, 0x28, 0x1114056b,},   //7.191875,   //17.078208  //
    {0x00, 0x06, 0x01, 0x00, 0x112bf6a3,},   //7.270000,   //17.171732  //
    {0x00, 0x06, 0x01, 0x04, 0x114e5205,},   //7.383594,   //17.305939  //
    {0x00, 0x06, 0x01, 0x08, 0x1170271e,},   //7.497187,   //17.438097  //
    {0x00, 0x06, 0x01, 0x0c, 0x119179f7,},   //7.610781,   //17.568267  //
    {0x00, 0x06, 0x01, 0x10, 0x11b24e6d,},   //7.724375,   //17.696509  //
    {0x00, 0x06, 0x01, 0x14, 0x11d2a831,},   //7.837969,   //17.822879  //
    {0x00, 0x06, 0x01, 0x18, 0x11f28aca,},   //7.951562,   //17.947430  //
    {0x00, 0x06, 0x01, 0x1c, 0x1211f99a,},   //8.065156,   //18.070215  //
    {0x00, 0x06, 0x01, 0x20, 0x1230f7de,},   //8.178750,   //18.191282  //
    {0x00, 0x06, 0x01, 0x24, 0x124f88b1,},   //8.292344,   //18.310680  //
    {0x00, 0x06, 0x01, 0x28, 0x126daf0e,},   //8.405938,   //18.428452  //
    {0x00, 0x06, 0x01, 0x2c, 0x128b6dcf,},   //8.519531,   //18.544644  //
    {0x00, 0x06, 0x01, 0x30, 0x12a8c7b4,},   //8.633125,   //18.659297  //
    {0x00, 0x06, 0x01, 0x34, 0x12c5bf60,},   //8.746719,   //18.772451  //
    {0x00, 0x06, 0x01, 0x38, 0x12e2575b,},   //8.860312,   //18.884145  //
    {0x00, 0x06, 0x01, 0x3c, 0x12fe9217,},   //8.973906,   //18.994417  //
    {0x00, 0x06, 0x01, 0x40, 0x131a71eb,},   //9.087500,   //19.103301  //
    {0x00, 0x06, 0x01, 0x44, 0x1335f919,},   //9.201094,   //19.210832  //
    {0x00, 0x06, 0x01, 0x48, 0x135129cf,},   //9.314687,   //19.317044  //
    {0x00, 0x06, 0x01, 0x4c, 0x136c0625,},   //9.428281,   //19.421969  //
    {0x00, 0x06, 0x01, 0x50, 0x13869020,},   //9.541875,   //19.525637  //
    {0x00, 0x06, 0x01, 0x54, 0x13a0c9b4,},   //9.655469,   //19.628078  //
    {0x00, 0x06, 0x01, 0x58, 0x13bab4c3,},   //9.769062,   //19.729321  //
    {0x00, 0x06, 0x01, 0x5c, 0x13d4531c,},   //9.882656,   //19.829393  //
    {0x00, 0x06, 0x01, 0x60, 0x13eda680,},   //9.996250,   //19.928322  //
    {0x00, 0x06, 0x01, 0x64, 0x1406b0a3,},   //10.109844,  //20.026133  //
    {0x00, 0x06, 0x01, 0x68, 0x141f7325,},   //10.223437,  //20.122851  //
    {0x00, 0x06, 0x01, 0x6c, 0x1437ef9e,},   //10.337031,  //20.218500  //
    {0x00, 0x06, 0x01, 0x70, 0x14502794,},   //10.450625,  //20.313104  //
    {0x00, 0x06, 0x01, 0x74, 0x14681c82,},   //10.564219,  //20.406685  //
    {0x00, 0x06, 0x01, 0x78, 0x147fcfd9,},   //10.677813,  //20.499265  //
    {0x00, 0x06, 0x01, 0x7c, 0x149742fb,},   //10.791406,  //20.590866  //
    {0x00, 0x06, 0x01, 0x80, 0x14ae7741,},   //10.905000,  //20.681507  //
    {0x00, 0x06, 0x01, 0x84, 0x14c56df7,},   //11.018594,  //20.771209  //
    {0x00, 0x06, 0x01, 0x88, 0x14dc2862,},   //11.132187,  //20.859991  //
    {0x00, 0x06, 0x01, 0x8c, 0x14f2a7bb,},   //11.245781,  //20.947872  //
    {0x00, 0x06, 0x01, 0x90, 0x1508ed32,},   //11.359375,  //21.034869  //
    {0x00, 0x06, 0x01, 0x94, 0x151ef9ed,},   //11.472969,  //21.121001  //
    {0x00, 0x06, 0x01, 0x98, 0x1534cf0b,},   //11.586562,  //21.206284  //
    {0x00, 0x06, 0x01, 0x9c, 0x154a6da1,},   //11.700156,  //21.290735  //
    {0x00, 0x06, 0x01, 0xa0, 0x155fd6be,},   //11.813750,  //21.374370  //
    {0x00, 0x06, 0x01, 0xa4, 0x15750b67,},   //11.927344,  //21.457205  //
    {0x00, 0x06, 0x01, 0xa8, 0x158a0c9c,},   //12.040938,  //21.539255  //
    {0x00, 0x07, 0x01, 0x00, 0x1596b917,},   //12.110000,  //21.588762  //
    {0x00, 0x07, 0x01, 0x04, 0x15b91478,},   //12.299219,  //21.722969  //
    {0x00, 0x07, 0x01, 0x08, 0x15dae991,},   //12.488438,  //21.855126  //
    {0x00, 0x07, 0x01, 0x0c, 0x15fc3c6a,},   //12.677656,  //21.985297  //
    {0x00, 0x07, 0x01, 0x10, 0x161d10e1,},   //12.866875,  //22.113539  //
    {0x00, 0x07, 0x01, 0x14, 0x163d6aa4,},   //13.056094,  //22.239909  //
    {0x00, 0x07, 0x01, 0x18, 0x165d4d3d,},   //13.245312,  //22.364460  //
    {0x00, 0x07, 0x01, 0x1c, 0x167cbc0d,},   //13.434531,  //22.487244  //
    {0x00, 0x07, 0x01, 0x20, 0x169bba51,},   //13.623750,  //22.608312  //
    {0x00, 0x07, 0x01, 0x24, 0x16ba4b24,},   //13.812969,  //22.727709  //
    {0x00, 0x07, 0x01, 0x28, 0x16d87181,},   //14.002188,  //22.845482  //
    {0x00, 0x07, 0x01, 0x2c, 0x16f63042,},   //14.191406,  //22.961674  //
    {0x00, 0x07, 0x01, 0x30, 0x17138a27,},   //14.380625,  //23.076327  //
    {0x00, 0x07, 0x01, 0x34, 0x173081d3,},   //14.569844,  //23.189481  //
    {0x00, 0x07, 0x01, 0x38, 0x174d19cf,},   //14.759062,  //23.301175  //
    {0x00, 0x07, 0x01, 0x3c, 0x1769548a,},   //14.948281,  //23.411446  //
    {0x00, 0x07, 0x01, 0x40, 0x1785345e,},   //15.137500,  //23.520330  //
    {0x00, 0x07, 0x01, 0x44, 0x17a0bb8c,},   //15.326719,  //23.627862  //
    {0x00, 0x07, 0x01, 0x48, 0x17bbec42,},   //15.515938,  //23.734074  //
    {0x00, 0x07, 0x01, 0x4c, 0x17d6c898,},   //15.705156,  //23.838998  //
    {0x00, 0x07, 0x01, 0x50, 0x17f15294,},   //15.894375,  //23.942666  //
    {0x00, 0x07, 0x01, 0x54, 0x180b8c28,},   //16.083594,  //24.045107  //
    {0x00, 0x07, 0x01, 0x58, 0x18257736,},   //16.272813,  //24.146350  //
    {0x00, 0x07, 0x01, 0x5c, 0x183f158f,},   //16.462031,  //24.246423  //
    {0x00, 0x07, 0x01, 0x60, 0x185868f4,},   //16.651250,  //24.345351  //
    {0x00, 0x07, 0x01, 0x64, 0x18717316,},   //16.840469,  //24.443162  //
    {0x00, 0x07, 0x01, 0x68, 0x188a3599,},   //17.029687,  //24.539880  //
    {0x00, 0x07, 0x01, 0x6c, 0x18a2b211,},   //17.218906,  //24.635530  //
    {0x00, 0x07, 0x01, 0x70, 0x18baea07,},   //17.408125,  //24.730133  //
    {0x00, 0x07, 0x01, 0x74, 0x18d2def6,},   //17.597344,  //24.823715  //
    {0x00, 0x07, 0x01, 0x78, 0x18ea924c,},   //17.786562,  //24.916295  //
    {0x00, 0x08, 0x01, 0x00, 0x18fed73a,},   //17.950000,  //24.995472  //
    {0x00, 0x08, 0x01, 0x04, 0x1921329c,},   //18.230469,  //25.129679  //
    {0x00, 0x08, 0x01, 0x08, 0x194307b4,},   //18.510938,  //25.261836  //
    {0x00, 0x08, 0x01, 0x0c, 0x19645a8e,},   //18.791406,  //25.392007  //
    {0x00, 0x08, 0x01, 0x10, 0x19852f04,},   //19.071875,  //25.520249  //
    {0x00, 0x08, 0x01, 0x14, 0x19a588c8,},   //19.352344,  //25.646618  //
    {0x00, 0x08, 0x01, 0x18, 0x19c56b61,},   //19.632813,  //25.771170  //
    {0x00, 0x08, 0x01, 0x1c, 0x19e4da31,},   //19.913281,  //25.893954  //
    {0x00, 0x08, 0x01, 0x20, 0x1a03d875,},   //20.193750,  //26.015022  //
    {0x00, 0x08, 0x01, 0x24, 0x1a226948,},   //20.474219,  //26.134419  //
    {0x00, 0x08, 0x01, 0x28, 0x1a408fa4,},   //20.754687,  //26.252192  //
    {0x00, 0x08, 0x01, 0x2c, 0x1a5e4e66,},   //21.035156,  //26.368384  //
    {0x00, 0x08, 0x01, 0x30, 0x1a7ba84b,},   //21.315625,  //26.483037  //
    {0x00, 0x08, 0x01, 0x34, 0x1a989ff7,},   //21.596094,  //26.596191  //
    {0x00, 0x08, 0x01, 0x38, 0x1ab537f2,},   //21.876562,  //26.707885  //
    {0x00, 0x08, 0x01, 0x3c, 0x1ad172ad,},   //22.157031,  //26.818156  //
    {0x00, 0x08, 0x01, 0x40, 0x1aed5281,},   //22.437500,  //26.927040  //
    {0x00, 0x08, 0x01, 0x44, 0x1b08d9b0,},   //22.717969,  //27.034572  //
    {0x00, 0x08, 0x01, 0x48, 0x1b240a65,},   //22.998437,  //27.140784  //
    {0x00, 0x08, 0x01, 0x4c, 0x1b3ee6bb,},   //23.278906,  //27.245708  //
    {0x00, 0x08, 0x01, 0x50, 0x1b5970b7,},   //23.559375,  //27.349376  //
    {0x00, 0x08, 0x01, 0x54, 0x1b73aa4b,},   //23.839844,  //27.451817  //
    {0x00, 0x08, 0x01, 0x58, 0x1b8d9559,},   //24.120313,  //27.553060  //
    {0x00, 0x08, 0x01, 0x5c, 0x1ba733b2,},   //24.400781,  //27.653133  //
    {0x00, 0x08, 0x01, 0x60, 0x1bc08717,},   //24.681250,  //27.752061  //
    {0x00, 0x09, 0x01, 0x00, 0x1bcebc3a,},   //24.840000,  //27.807560  //
    {0x00, 0x09, 0x01, 0x04, 0x1bf1179b,},   //25.228125,  //27.941766  //
    {0x00, 0x09, 0x01, 0x08, 0x1c12ecb4,},   //25.616250,  //28.073924  //
    {0x00, 0x09, 0x01, 0x0c, 0x1c343f8d,},   //26.004375,  //28.204095  //
    {0x00, 0x09, 0x01, 0x10, 0x1c551403,},   //26.392500,  //28.332337  //
    {0x00, 0x09, 0x01, 0x14, 0x1c756dc7,},   //26.780625,  //28.458706  //
    {0x00, 0x09, 0x01, 0x18, 0x1c955060,},   //27.168750,  //28.583258  //
    {0x00, 0x09, 0x01, 0x1c, 0x1cb4bf30,},   //27.556875,  //28.706042  //
    {0x00, 0x09, 0x01, 0x20, 0x1cd3bd74,},   //27.945000,  //28.827110  //
    {0x00, 0x09, 0x01, 0x24, 0x1cf24e47,},   //28.333125,  //28.946507  //
    {0x00, 0x09, 0x01, 0x28, 0x1d1074a4,},   //28.721250,  //29.064280  //
    {0x00, 0x09, 0x01, 0x2c, 0x1d2e3365,},   //29.109375,  //29.180472  //
    {0x00, 0x09, 0x01, 0x30, 0x1d4b8d4a,},   //29.497500,  //29.295125  //
    {0x00, 0x09, 0x01, 0x34, 0x1d6884f6,},   //29.885625,  //29.408279  //
    {0x00, 0x09, 0x01, 0x38, 0x1d851cf2,},   //30.273750,  //29.519973  //
    {0x00, 0x09, 0x01, 0x3c, 0x1da157ad,},   //30.661875,  //29.630244  //
    {0x00, 0x09, 0x01, 0x40, 0x1dbd3781,},   //31.050000,  //29.739128  //
    {0x00, 0x09, 0x01, 0x44, 0x1dd8beaf,},   //31.438125,  //29.846660  //
    {0x00, 0x09, 0x01, 0x48, 0x1df3ef65,},   //31.826250,  //29.952872  //
    {0x00, 0x09, 0x01, 0x4c, 0x1e0ecbbb,},   //32.214375,  //30.057796  //
    {0x00, 0x09, 0x01, 0x50, 0x1e2955b6,},   //32.602500,  //30.161464  //
    {0x00, 0x09, 0x01, 0x54, 0x1e438f4b,},   //32.990625,  //30.263905  //
    {0x00, 0x09, 0x01, 0x58, 0x1e5d7a59,},   //33.378750,  //30.365148  //
    {0x00, 0x09, 0x01, 0x5c, 0x1e7718b2,},   //33.766875,  //30.465221  //
    {0x00, 0x09, 0x01, 0x60, 0x1e906c17,},   //34.155000,  //30.564149  //
    {0x00, 0x09, 0x01, 0x64, 0x1ea97639,},   //34.543125,  //30.661960  //
    {0x00, 0x09, 0x01, 0x68, 0x1ec238bb,},   //34.931250,  //30.758678  //
    {0x00, 0x09, 0x01, 0x6c, 0x1edab534,},   //35.319375,  //30.854327  //
    {0x00, 0x09, 0x01, 0x70, 0x1ef2ed2a,},   //35.707500,  //30.948931  //
    {0x00, 0x09, 0x01, 0x74, 0x1f0ae219,},   //36.095625,  //31.042512  //
    {0x00, 0x09, 0x01, 0x78, 0x1f22956f,},   //36.483750,  //31.135093  //
    {0x00, 0x0a, 0x01, 0x00, 0x1f269aa1,},   //36.550000,  //31.150797  //
    {0x00, 0x0a, 0x01, 0x04, 0x1f48f603,},   //37.121094,  //31.285004  //
    {0x00, 0x0a, 0x01, 0x08, 0x1f6acb1c,},   //37.692187,  //31.417162  //
    {0x00, 0x0a, 0x01, 0x0c, 0x1f8c1df5,},   //38.263281,  //31.547332  //
    {0x00, 0x0a, 0x01, 0x10, 0x1facf26b,},   //38.834375,  //31.675574  //
    {0x00, 0x0a, 0x01, 0x14, 0x1fcd4c2f,},   //39.405469,  //31.801944  //
    {0x00, 0x0a, 0x01, 0x18, 0x1fed2ec8,},   //39.976563,  //31.926495  //
    {0x00, 0x0a, 0x01, 0x1c, 0x200c9d98,},   //40.547656,  //32.049280  //
    {0x00, 0x0a, 0x01, 0x20, 0x202b9bdc,},   //41.118750,  //32.170347  //
    {0x00, 0x0a, 0x01, 0x24, 0x204a2caf,},   //41.689844,  //32.289744  //
    {0x00, 0x0a, 0x01, 0x28, 0x2068530c,},   //42.260937,  //32.407517  //
    {0x00, 0x0a, 0x01, 0x2c, 0x208611cd,},   //42.832031,  //32.523709  //
    {0x00, 0x0a, 0x01, 0x30, 0x20a36bb2,},   //43.403125,  //32.638362  //
    {0x00, 0x0a, 0x01, 0x34, 0x20c0635e,},   //43.974219,  //32.751516  //
    {0x00, 0x0a, 0x01, 0x38, 0x20dcfb59,},   //44.545312,  //32.863210  //
    {0x00, 0x0a, 0x01, 0x3c, 0x20f93615,},   //45.116406,  //32.973481  //
    {0x00, 0x0a, 0x01, 0x40, 0x211515e9,},   //45.687500,  //33.082366  //
    {0x00, 0x0a, 0x01, 0x44, 0x21309d17,},   //46.258594,  //33.189897  //
    {0x00, 0x0a, 0x01, 0x48, 0x214bcdcd,},   //46.829687,  //33.296109  //
    {0x00, 0x0a, 0x01, 0x4c, 0x2166aa23,},   //47.400781,  //33.401034  //
    {0x00, 0x0a, 0x01, 0x50, 0x2181341e,},   //47.971875,  //33.504702  //
    {0x00, 0x0a, 0x01, 0x54, 0x219b6db2,},   //48.542969,  //33.607143  //
    {0x00, 0x0a, 0x01, 0x58, 0x21b558c1,},   //49.114062,  //33.708386  //
    {0x00, 0x0a, 0x01, 0x5c, 0x21cef71a,},   //49.685156,  //33.808458  //
    {0x00, 0x0a, 0x01, 0x60, 0x21e84a7e,},   //50.256250,  //33.907387  //
    {0x00, 0x0a, 0x01, 0x64, 0x220154a1,},   //50.827344,  //34.005198  //
    {0x00, 0x0a, 0x01, 0x68, 0x221a1723,},   //51.398437,  //34.101916  //
    {0x00, 0x0a, 0x01, 0x6c, 0x2232939c,},   //51.969531,  //34.197565  //
    {0x00, 0x0a, 0x01, 0x70, 0x224acb92,},   //52.540625,  //34.292169  //
    {0x00, 0x0a, 0x01, 0x74, 0x2262c080,},   //53.111719,  //34.385750  //
    {0x00, 0x0a, 0x01, 0x78, 0x227a73d7,},   //53.682812,  //34.478330  //
    {0x00, 0x0a, 0x01, 0x7c, 0x2291e6f9,},   //54.253906,  //34.569931  //
    {0x00, 0x0a, 0x01, 0x80, 0x22a91b3f,},   //54.825000,  //34.660572  //
    {0x00, 0x0a, 0x01, 0x84, 0x22c011f5,},   //55.396094,  //34.750274  //
    {0x00, 0x0a, 0x01, 0x88, 0x22d6cc60,},   //55.967187,  //34.839056  //
    {0x00, 0x0a, 0x01, 0x8c, 0x22ed4bb9,},   //56.538281,  //34.926937  //
    {0x00, 0x0a, 0x01, 0x90, 0x23039130,},   //57.109375,  //35.013934  //
    {0x00, 0x0a, 0x01, 0x94, 0x23199deb,},   //57.680469,  //35.100066  //
    {0x00, 0x0a, 0x01, 0x98, 0x232f7309,},   //58.251562,  //35.185349  //
    {0x00, 0x0a, 0x01, 0x9c, 0x2345119f,},   //58.822656,  //35.269800  //
    {0x00, 0x0a, 0x01, 0xa0, 0x235a7abc,},   //59.393750,  //35.353435  //
    {0x00, 0x0a, 0x01, 0xa4, 0x236faf65,},   //59.964844,  //35.436270  //
    {0x00, 0x0a, 0x01, 0xa8, 0x2384b09a,},   //60.535937,  //35.518320  //
    {0x00, 0x0a, 0x01, 0xac, 0x23997f50,},   //61.107031,  //35.599599  //
    {0x00, 0x0a, 0x01, 0xb0, 0x23ae1c7a,},   //61.678125,  //35.680122  //
    {0x00, 0x0a, 0x01, 0xb4, 0x23c28900,},   //62.249219,  //35.759903  //
    {0x00, 0x0a, 0x01, 0xb8, 0x23d6c5c6,},   //62.820312,  //35.838955  //
    {0x00, 0x0a, 0x01, 0xbc, 0x23ead3a9,},   //63.391406,  //35.917292  //
    {0x00, 0x0a, 0x01, 0xc0, 0x23feb381,},   //63.962500,  //35.994927  //
    {0x00, 0x0a, 0x01, 0xc4, 0x2412661f,},   //64.533594,  //36.071871  //
    {0x00, 0x0a, 0x01, 0xc8, 0x2425ec4f,},   //65.104687,  //36.148137  //
    {0x00, 0x0a, 0x01, 0xcc, 0x243946d9,},   //65.675781,  //36.223737  //
    {0x00, 0x0a, 0x01, 0xd0, 0x244c767c,},   //66.246875,  //36.298683  //
    {0x00, 0x0a, 0x01, 0xd4, 0x245f7bf7,},   //66.817969,  //36.372985  //
    {0x00, 0x0a, 0x01, 0xd8, 0x24725800,},   //67.389062,  //36.446655  //
    {0x00, 0x0a, 0x01, 0xdc, 0x24850b4b,},   //67.960156,  //36.519704  //
    {0x00, 0x0a, 0x01, 0xe0, 0x24979686,},   //68.531250,  //36.592141  //
    {0x00, 0x0a, 0x01, 0xe4, 0x24a9fa5b,},   //69.102344,  //36.663976  //
    {0x00, 0x0a, 0x01, 0xe8, 0x24bc3772,},   //69.673437,  //36.735221  //
    {0x00, 0x0a, 0x01, 0xec, 0x24ce4e6a,},   //70.244531,  //36.805884  //
    {0x00, 0x0a, 0x01, 0xf0, 0x24e03fe3,},   //70.815625,  //36.875975  //
    {0x00, 0x0a, 0x01, 0xf4, 0x24f20c77,},   //71.386719,  //36.945503  //
    {0x00, 0x0a, 0x01, 0xf8, 0x2503b4bc,},   //71.957812,  //37.014477  //
    {0x00, 0x0a, 0x01, 0xfc, 0x25153945,},   //72.528906,  //37.082905  //
};

//*****************************************************************************
//*****************************************************************************
//** Local Functions Declaration
//*****************************************************************************
//*****************************************************************************



//*****************************************************************************
//*****************************************************************************
//** API Functions
//*****************************************************************************
//*****************************************************************************
static int gc1024_get_vblank_time(int handle, GK_Vi_SensorT* sensor_extern, u32* ptime, u32 extclk, u32 pclk)
{
    int                     errorCode       = 0;
    u64                     v_btime;
    //u32                     vertical_lines  = 0;
    u32                     line_length     = 0;

    u32     hb_h, hb_l, sh_delay_h, sh_delay_l, win_width_h, win_width_l;
    u32     vb_h, vb_l;  //win_height_h, win_height_l;
    u32     vb;

    //page set to 0.
    sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x0, 1);  //page set to 0.
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_VB_H, &vb_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_VB_L, &vb_l, 1);
    //errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_H, &win_height_h, 1);
    //errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_L, &win_height_l, 1);
    vb = (vb_h<<8) + vb_l;
    //vmax = VB+ Vt +16
    //BUG_ON(vertical_lines == 0);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_H, &hb_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_L, &hb_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_H, &sh_delay_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_L, &sh_delay_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_H, &win_width_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_L, &win_width_l, 1);
    line_length = (hb_h<<8) + hb_l + (sh_delay_h<<8) + sh_delay_l + (((win_width_h<<8) + win_width_l)>>1) + 4;
    //hmax = Hb + Sh_delay + win_width /2+ 4;
    BUG_ON(line_length == 0);

    v_btime = (u64)line_length * (u64)vb * 1000000000;
    // ns
    //if(sensor.vmax_clk_ref == GK_SENSOR_CAL_CLK_PIXCLK_DIV2)
    DO_DIV_ROUND(v_btime, (u64)pclk / 2);

    *ptime = v_btime;

    return errorCode;
}

static int gc1024_set_agc_db(int handle, GK_Vi_SensorT* sensor_extern, s32 agc_db)
{
    int                     errorCode = 0;
    u32                     idc_reg0, idc_reg1, idc_reg2, idc_reg3;
    u32                     gain_index = GC1024_GAIN_ROWS;
    int                     i;
#ifdef SET_REG_BY_VSYNC
    GK_Vi_Sensor_GC1024T*   pdata = (GK_Vi_Sensor_GC1024T*)sensor_extern->private_data;
#endif
    //printk("[%s %d]%08x\n", __func__, __LINE__, agc_db);

    for(i = 0; i < GC1024_GAIN_ROWS; i++)
    {
        if(GC1024_GLOBAL_GAIN_TABLE[i].db_value > agc_db)
        {
            gain_index = i;
            break;
        }
    }
    if(gain_index>0)
        gain_index--;

    if (gain_index >= GC1024_GAIN_ROWS)
    {
        errorCode = -EINVAL;
        return errorCode;
    }
    //0602 hhl add print
    //printk("hhl add: gain_index=%d \n", gain_index);
    idc_reg0 = GC1024_GLOBAL_GAIN_TABLE[gain_index].GC1024_REG_FE;
    idc_reg1 = GC1024_GLOBAL_GAIN_TABLE[gain_index].GC1024_REG_B6;
    idc_reg2 = GC1024_GLOBAL_GAIN_TABLE[gain_index].GC1024_REG_B1;
    idc_reg3 = GC1024_GLOBAL_GAIN_TABLE[gain_index].GC1024_REG_B2;
#ifdef SET_REG_BY_VSYNC
    //printk("hhl add by v_sync: gain: 0x%x  0x%x  0x%x\n", idc_reg1,idc_reg2,idc_reg3);
    //0918 hhl modify for anti-flicker
    if(pdata->gc1024_adc_ch == 0)
    {
        pdata->gc1024_reg_fe = idc_reg0;
        pdata->gc1024_reg_b6 = idc_reg1;
        pdata->gc1024_reg_b1 = idc_reg2;
        pdata->gc1024_reg_b2 = idc_reg3;

        pdata->gc1024_adc_ch = 1;
    }
#else
    //0602 hhl add print
    //printk("hhl add by set: gain: 0x%x  0x%x  0x%x\n", idc_reg1,idc_reg2,idc_reg3);
    sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x00,1);  //page set
    sensor_write_reg_ex(handle, GC1024_REG_ANA_GIAN, idc_reg1,1);  //global_gain
    sensor_write_reg_ex(handle, GC1024_REG_DIG_GIAN_IN, idc_reg2,1);     //pre_gain
    sensor_write_reg_ex(handle, GC1024_REG_DIR_GIAN_DE, idc_reg3,1);    //post_gain
#endif

    return errorCode;
}

static int gc1024_set_shutter_time(int handle, GK_Vi_SensorT* sensor_extern, u32 shutter_time, u32 extclk, u32 pclk)
{
    int     errorCode = 0;
    u64     exposure_time_q9;
    u32     frame_length, line_length;
    u32     hb_h, hb_l, sh_delay_h, sh_delay_l, win_width_h, win_width_l;
    u32     vb_h, vb_l, win_height_h, win_height_l;
    u32     exp_h, exp_l;
    GK_Vi_Sensor_GC1024T*   pdata = (GK_Vi_Sensor_GC1024T*)sensor_extern->private_data;
    //u8     vts1, vts2;
    //printk("[%s %d]%08x\n", __func__, __LINE__, shutter_time);

    exposure_time_q9 = shutter_time;

    //page set to 0.
    sensor_write_reg_ex(handle, 0xFE, 0x0,1);  //page set to 0.
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_VB_H, &vb_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_VB_L, &vb_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_H, &win_height_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_L, &win_height_l, 1);
    frame_length = (vb_h<<8) + vb_l + (win_height_h<<8) + win_height_l + 16;
    //vmax = VB+ Vt +16

    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_H, &hb_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_L, &hb_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_H, &sh_delay_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_L, &sh_delay_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_H, &win_width_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_L, &win_width_l, 1);
    line_length = (hb_h<<8) + hb_l + (sh_delay_h<<8) + sh_delay_l + (((win_width_h<<8) + win_width_l)>>1) + 4;
    //hmax = Hb + Sh_delay + win_width /2+ 4;
    //0918 hhl add for temp_test
    //line_length = 1039;
    //frame_length = 924;

    /* t(frame)/t(per line) = t(exposure, in lines)*/
    exposure_time_q9 = exposure_time_q9 * (u64)pclk / 2;// gc1024 spec: Hmax unit : pclk/2
    DO_DIV_ROUND(exposure_time_q9, line_length);
    DO_DIV_ROUND(exposure_time_q9, 512000000);

    if(pdata->fps_set_flag == 1)
    {
        if((pdata->fps_frame_len_bak - 4) < exposure_time_q9)
        {
            exposure_time_q9 = pdata->fps_frame_len_bak - 4;
        }
        pdata->fps_set_flag = 0;
    }
    else
    {
        if((frame_length - 4) < exposure_time_q9)
        {
            exposure_time_q9 = frame_length - 4;
        }
    }

    exp_h = (exposure_time_q9 >> 8) & 0x0f;
    exp_l = exposure_time_q9 & 0xff;

    //0728 hhl add print
    //printk("shutter_time=%d  frame_length=%x  exposure_time_q9=0x%x  \n", shutter_time, frame_length, exposure_time_q9);

#ifdef SET_REG_BY_VSYNC
#ifdef SET_SHUTTER_BY_VSYNC
    pdata->gc1024_reg_exp_time_h = exp_h;
    pdata->gc1024_reg_exp_time_l = exp_l;
    pdata->gc1024_shutter_ch = 1;
#else
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_H, exp_h, 1);  //
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_L, exp_l, 1);
#endif
#else
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_H, exp_h, 1);  //
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_L, exp_l, 1);
#endif

    return errorCode;
}

static int gc1024_set_fps(int handle, GK_Vi_SensorT* sensor_extern, u32 fps, u32 extclk, u32 pclk)
{
    int errorCode = 0;
    u32 hb_h, hb_l, sh_delay_h, sh_delay_l, win_width_h, win_width_l;
    u32 vb_h, vb_l, win_height_h, win_height_l;
    u32 fps_v = 512000000/fps;
    u32 line_length = 800;  //default 25fps.
    u32 frame_length = 900;  //default 25fps.
    u32 gc1024_vb = 0xA0;  //default 25fps.
    GK_Vi_Sensor_GC1024T*   pdata = (GK_Vi_Sensor_GC1024T*)sensor_extern->private_data;
    //printk("[%s %d]%08x\n", __func__, __LINE__, fps);
    //printk("debug print: fps=%d  pclk=%d \n", fps_v, pclk);

    //page set to 0.
    sensor_write_reg_ex(handle, 0xFE, 0x0,1);  //page set to 0.

    #if 0 //here is sth wrong: hb_l holds default value(0xf4) when 1st time here.
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_H, &hb_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_HB_L, &hb_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_H, &sh_delay_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_SH_DELAY_L, &sh_delay_l, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_H, &win_width_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_WIDTH_L, &win_width_l, 1);
    line_length = (hb_h<<8) + hb_l + (sh_delay_h<<8) + sh_delay_l + (((win_width_h<<8) + win_width_l)>>1) + 4;
    //hmax = Hb + Sh_delay + win_width /2+ 4;
    #else
    line_length = 1039;  //Always 1039 under 720p.
    #endif
    frame_length = pclk/fps_v/(2*line_length);

    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_H, &win_height_h, 1);
    errorCode |= sensor_read_reg_ex(handle, GC1024_REG_WIN_HEIGHT_L, &win_height_l, 1);

    gc1024_vb = frame_length - ((win_height_h<<8) + win_height_l + 16);
    vb_h = (gc1024_vb>>8) & 0xff;
    vb_l = gc1024_vb & 0xff;

    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_VB_H, vb_h, 1);  //
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_VB_L, vb_l, 1);

    pdata->fps_set_flag = 1;
    pdata->fps_frame_len_bak = frame_length;
    //printk("frame_length: 0x%x  \n", frame_length);

    return errorCode;
}

static int gc1024_set_mirror_mode(int handle, GK_Vi_SensorT* sensor_extern, u32 mirr_mode)
{
    int errorCode = 0;
    GK_Vi_Sensor_GC1024T*   pdata = (GK_Vi_Sensor_GC1024T*)sensor_extern->private_data;
    if(mirr_mode == 0)
    {
        pdata->gc1024_crop_ver_l = 0x01;
        pdata->gc1024_crop_hor_l = 0x03;
        pdata->gc1024_mirror_flip = 0x03;
    }
    else if(mirr_mode == 1)
    {
        pdata->gc1024_crop_ver_l = 0x00;
        pdata->gc1024_crop_hor_l = 0x03;
        pdata->gc1024_mirror_flip = 0x01;
    }
    else if(mirr_mode == 2)
    {
        pdata->gc1024_crop_ver_l = 0x01;
        pdata->gc1024_crop_hor_l = 0x02;
        pdata->gc1024_mirror_flip = 0x02;
    }
    else if(mirr_mode == 3)
    {
        pdata->gc1024_crop_ver_l = 0x00;
        pdata->gc1024_crop_hor_l = 0x02;
        pdata->gc1024_mirror_flip = 0x00;
    }
    else
    {
        return(0);
    }

#ifdef SET_REG_BY_VSYNC
    pdata->gc1024_mirror_need_up = 1;
#else
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x00, 1);
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_CLIP_VER_L, pdata->gc1024_crop_ver_l, 1);
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_CLIP_HOR_L, pdata->gc1024_crop_hor_l, 1);
    errorCode |= sensor_write_reg_ex(handle, GC1024_REG_MIRROR_FLIP, pdata->gc1024_mirror_flip, 1);

    pdata->gc1024_mirror_need_up = 0;
#endif

    return errorCode;
}

static int gc1024_set_update_reg(int handle, GK_Vi_SensorT* sensor_extern)
{
    GK_Vi_Sensor_GC1024T*   pdata = (GK_Vi_Sensor_GC1024T*)sensor_extern->private_data;
    //printk("[%s %d]\n", __func__, __LINE__);

#ifdef SET_REG_BY_VSYNC
#ifdef SET_SHUTTER_BY_VSYNC
    if(pdata->gc1024_shutter_ch == 1)
    {
        sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x0,0);
        if(pdata->gc1024_last_reg_exp_time_h!=gc1024_reg_exp_time_h)
        {
            sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_H, gc1024_reg_exp_time_h,0);
        }
        if(pdata->gc1024_last_reg_exp_time_l!=pdata->gc1024_reg_exp_time_l)
        {
            sensor_write_reg_ex(handle, GC1024_REG_EXP_TIME_L, gc1024_reg_exp_time_l,0);
        }

        pdata->gc1024_last_reg_exp_time_h = pdata->gc1024_reg_exp_time_h;
        pdata->gc1024_last_reg_exp_time_l = pdata->gc1024_reg_exp_time_l;
        pdata->gc1024_shutter_ch = 0;
    }
#endif

    if(pdata->gc1024_adc_ch == 1)
    {
        //if (gc1024_last_reg_fe != gc1024_reg_fe)
        //{
        //    sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, gc1024_reg_fe,0);
        //}
        sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x00, 0);  //hhl note: page0 for gc1024.
        if (pdata->gc1024_last_reg_b6 != pdata->gc1024_reg_b6)
        {
            sensor_write_reg_ex(handle, GC1024_REG_ANA_GIAN, pdata->gc1024_reg_b6,0);
        }
        if (pdata->gc1024_last_reg_b1 != pdata->gc1024_reg_b1)
        {
            sensor_write_reg_ex(handle, GC1024_REG_DIG_GIAN_IN, pdata->gc1024_reg_b1,0);
            sensor_write_reg_ex(handle, GC1024_REG_DIR_GIAN_DE, pdata->gc1024_reg_b2,0);  //0xb1 act when 0xb2 set.
        }
        else if (pdata->gc1024_last_reg_b2 != pdata->gc1024_reg_b2)
        {
            sensor_write_reg_ex(handle, GC1024_REG_DIR_GIAN_DE, pdata->gc1024_reg_b2,0);
        }
        pdata->gc1024_adc_ch = 0;
        pdata->gc1024_last_reg_fe = pdata->gc1024_reg_fe;
        pdata->gc1024_last_reg_b6 = pdata->gc1024_reg_b6;
        pdata->gc1024_last_reg_b1 = pdata->gc1024_reg_b1;
        pdata->gc1024_last_reg_b2 = pdata->gc1024_reg_b2;
    }

    if(pdata->gc1024_mirror_need_up == 1)
    {
        sensor_write_reg_ex(handle, GC1024_REG_PAGE_SET, 0x00, 0);
        sensor_write_reg_ex(handle, GC1024_REG_MIRROR_FLIP, pdata->gc1024_mirror_flip, 0);
        sensor_write_reg_ex(handle, GC1024_REG_CLIP_VER_L, pdata->gc1024_crop_ver_l, 0);
        sensor_write_reg_ex(handle, GC1024_REG_CLIP_HOR_L, pdata->gc1024_crop_hor_l, 0);

        pdata->gc1024_mirror_need_up = 0;
    }

#endif
    return 0;
}


int gc1024_probe(GK_Vi_SensorT* sensor_extern, int id)
{
    GK_Vi_Sensor_GC1024T *gc1024_data = NULL;

    sensor_extern->private_data = kzalloc(sizeof(GK_Vi_Sensor_GC1024T), GFP_KERNEL);
    if (sensor_extern->private_data == NULL)
    {
        printk("kzalloc memory(0x%04x) failed\n", sizeof(GK_Vi_Sensor_GC1024T));
        return -1;
    }
    gc1024_data = sensor_extern->private_data;

    gc1024_data->sub_id = id;

#ifdef SET_REG_BY_VSYNC
    gc1024_data->gc1024_adc_ch = 0;
    gc1024_data->gc1024_reg_fe = 0x00;  //page0
    gc1024_data->gc1024_reg_b6 = 0x00;  //agc: 0=>1x
    gc1024_data->gc1024_reg_b1 = 0x01;  //dgc: 1.0x
    gc1024_data->gc1024_reg_b2 = 0x00;  //dgc: 1.0x

    gc1024_data->gc1024_last_reg_fe = 0xffffffff;
    gc1024_data->gc1024_last_reg_b6 = 0xffffffff;
    gc1024_data->gc1024_last_reg_b1 = 0xffffffff;
    gc1024_data->gc1024_last_reg_b2 = 0xffffffff;

#ifdef SET_SHUTTER_BY_VSYNC
    gc1024_data->gc1024_shutter_ch = 0;
    gc1024_data->gc1024_reg_exp_time_h = 0;
    gc1024_data->gc1024_reg_exp_time_l = 0;

    gc1024_data->gc1024_last_reg_exp_time_h = 0xffffffff;
    gc1024_data->gc1024_last_reg_exp_time_l = 0xffffffff;
#endif
#endif

    gc1024_data->gc1024_mirror_need_up = 0;
    gc1024_data->gc1024_crop_ver_l = 0x01;
    gc1024_data->gc1024_crop_hor_l = 0x03;
    gc1024_data->gc1024_mirror_flip = 0x03;

        //0728 hhl add for fps_change bug.
    gc1024_data->fps_set_flag = 0;
    gc1024_data->fps_frame_len_bak = 921; //default: 20fps   //900: 25fps

    return 0;
}

int gc1024_remove(GK_Vi_SensorT* sensor_extern)
{
    if (sensor_extern->private_data)
    {
        kfree(sensor_extern->private_data);
        sensor_extern->private_data = NULL;
    }
    return 0;
}

//*****************************************************************************
//*****************************************************************************
//** Local Functions
//*****************************************************************************
//*****************************************************************************
static int __init gc1024_init(void)
{
    gc1024_dev.sensor_id                = GK_VI_SENSOR_GC1024;
    gc1024_dev.length                   = sizeof(gc1024_dev);

    gc1024_dev.private_data             = NULL;
    gc1024_dev.probe                    = gc1024_probe;
    gc1024_dev.remove                   = gc1024_remove;
    gc1024_dev.sensor_get_vblank_time   = gc1024_get_vblank_time;
    gc1024_dev.sensor_set_shutter_time  = gc1024_set_shutter_time;
    gc1024_dev.sensor_set_fps           = gc1024_set_fps;
    gc1024_dev.sensor_set_agc_db        = gc1024_set_agc_db;
    gc1024_dev.sensor_set_mirror_mode   = gc1024_set_mirror_mode;
    gc1024_dev.sensor_set_update_reg    = gc1024_set_update_reg;
    sensor_registry_api((GK_Vi_SensorT*)&gc1024_dev);
    return 0;
}

static void __exit gc1024_exit(void)
{
    sensor_unregistry_api((GK_Vi_SensorT*)&gc1024_dev);
}

module_init(gc1024_init);
module_exit(gc1024_exit);
MODULE_LICENSE("GPL");
MODULE_AUTHOR("GOKE MICROELECTRONICS Inc.");
MODULE_DESCRIPTION("GC1024 1/6.5-Inch CMOS Digital Image Sensor");

